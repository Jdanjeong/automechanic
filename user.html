<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤í”ˆë§í¬ í˜‘ë ¥ì‚¬ í˜„í™©</title>
  <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=y42tkwc67w&submodules=geocoder"></script>
  <style>
    /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ automechanic.htmlê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
    body { font-family: 'Arial', sans-serif; margin: 20px; }
    #map { width: 100%; height: 600px; border-radius: 8px; margin-top: 10px; }
    .radius-buttons button { margin-right: 10px; padding: 5px 10px; border-radius: 5px; background-color: #e0e7ff; border: none; cursor: pointer; }
    .radius-buttons button:hover { background-color: #c7d2fe; }
    input[type="text"] { padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
    button { padding: 6px 10px; border-radius: 4px; background-color: #38bdf8; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0ea5e9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: clamp(12px, 1.1vw, 16px); table-layout: fixed; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; word-break: break-word; }
    th { background-color: #eef2ff; }
    .info-card { padding: 15px; border: 1px solid #ddd; border-radius: 10px; background: #fff; margin-top: 10px; }
  </style>
</head>
<body>
  <img src="https://taksong-driver.openmile.kr/openlink.png" style="width: 139px; height: 22px;" />
  <h2>ğŸ¢ ì˜¤í”ˆë§í¬ í˜‘ë ¥ì‚¬ í˜„í™©</h2>

  <div>
    <input type="text" id="addressInput" placeholder="ğŸ” ì£¼ì†Œ ì…ë ¥">
    <button onclick="searchAddress()">ê²€ìƒ‰</button>
    <span>ë˜ëŠ” ğŸ—ºï¸ ì§€ë„ í´ë¦­ìœ¼ë¡œ ì„ íƒ</span>
  </div>

  <div class="radius-buttons">
    <label>ğŸ“ ë°˜ê²½:</label>
    <button onclick="setRadius(5)">5km</button>
    <button onclick="setRadius(10)">10km</button>
    <button onclick="setRadius(20)">20km</button>
  </div>

  <div id="map"></div>

  <div id="clicked-address">ğŸ“ í‘œì‹œì§€ì ì˜ ì£¼ì†Œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  <div id="clicked-location">ğŸ“ ì„ íƒëœ ìœ„ì¹˜: ì—†ìŒ</div>
  <div id="factory-info">â„¹ï¸ í˜‘ë ¥ì‚¬ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

  <table>
    <thead>
      <tr>
        <th>ê³µì—…ì‚¬ëª…</th>
        <th>ê±°ë¦¬(km)</th>
        <th>ì¼ë°˜ìˆ˜ë¦¬</th>
        <th>ì‚¬ê³ ìˆ˜ë¦¬</th>
        <th>í˜„ëŒ€</th>
        <th>ê¸°ì•„</th>
      </tr>
    </thead>
    <tbody id="factory-list"></tbody>
  </table>

  <script>
    let map, radius = 10, circle = null, selectedMarker = null;
    let factories = [], markers = [];

    function getStatusTag(flag) {
      if (flag === 'â—‹') return 'âœ…';
      if (flag === 'â…©' || flag === 'X') return 'âŒ';
      return '-';
    }

    function showFactoryInfo(f) {
      document.getElementById("factory-info").innerHTML = `
        <div class="info-card">
          <strong>ğŸš— ${f.name}</strong><br>
          ğŸ“ ${f.address}<br>
          â˜ï¸ ${f.phone || '-'}<br>
          ğŸ·ï¸ ë“±ê¸‰: ${f.grade || '-'}<br>
          ğŸ“¦ ì›”ìˆ˜ë¦¬: ${f.monthlyCapacity || '-'}, ì…ê³ : ${f.currentIncoming || '-'}, ê°€ëŠ¥: ${f.possibleIncoming || '-'}<br>
          ì¼ë°˜ìˆ˜ë¦¬: ${getStatusTag(f.repairGeneral)}, ì‚¬ê³ ìˆ˜ë¦¬: ${getStatusTag(f.repairAccident)}<br>
          í˜„ëŒ€: ${getStatusTag(f.pointHyundai)}, ê¸°ì•„: ${getStatusTag(f.pointKia)}<br>
          ğŸ“ ${f.notes || ''}
        </div>`;
    }

    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371e3, toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function updateTableAndMarkers(center) {
      const tbody = document.getElementById("factory-list");
      tbody.innerHTML = '';

      markers.forEach(m => m.setMap(null));
      markers = [];

      factories.forEach(f => {
        const dist = haversine(center.lat(), center.lng(), f.lat, f.lng) / 1000;
        if (dist <= radius) {
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(f.lat, f.lng),
            map
          });
          marker.addListener("click", () => showFactoryInfo(f));
          markers.push(marker);

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${f.name}</td>
            <td>${dist.toFixed(2)}</td>
            <td>${getStatusTag(f.repairGeneral)}</td>
            <td>${getStatusTag(f.repairAccident)}</td>
            <td>${getStatusTag(f.pointHyundai)}</td>
            <td>${getStatusTag(f.pointKia)}</td>`;
          row.onclick = () => showFactoryInfo(f);
          tbody.appendChild(row);
        }
      });
    }

    function drawCircle(center) {
      if (circle) circle.setMap(null);
      circle = new naver.maps.Circle({
        map,
        center,
        radius: radius * 1000,
        strokeColor: "#007aff",
        strokeWeight: 2,
        fillColor: "#cce5ff",
        fillOpacity: 0.4
      });
    }

    function searchAddress() {
      const query = document.getElementById("addressInput").value;
      if (!query) return;
      naver.maps.Service.geocode({ query }, function(status, response) {
        if (status !== naver.maps.Service.Status.OK) return alert("ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨");
        const item = response.v2.addresses[0];
        const latlng = new naver.maps.LatLng(item.y, item.x);
        if (selectedMarker) selectedMarker.setMap(null);
        selectedMarker = new naver.maps.Marker({ position: latlng, map });
        map.setCenter(latlng);
        document.getElementById("clicked-location").innerText = `ğŸ“ ì„ íƒëœ ìœ„ì¹˜: ${item.roadAddress || item.jibunAddress}`;
        drawCircle(latlng);
        updateTableAndMarkers(latlng);
      });
    }

    function setRadius(r) {
      radius = r;
      if (selectedMarker) {
        drawCircle(selectedMarker.getPosition());
        updateTableAndMarkers(selectedMarker.getPosition());
      }
    }

    function initMap() {
      map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(36.5, 127.5),
        zoom: 8
      });

      fetch("https://jdanjeong.github.io/automechanic/factory.json")
        .then(res => res.json())
        .then(data => {
          factories = data;
        })
        .catch(err => alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"));
    }

    window.onload = initMap;
  </script>
</body>
</html>
