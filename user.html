<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>오픈링크 협력사 현황</title>
  <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=y42tkwc67w&submodules=geocoder"></script>
  <style>
    /* 스타일은 기존 automechanic.html과 동일하게 유지 */
    body { font-family: 'Arial', sans-serif; margin: 20px; }
    #map { width: 100%; height: 600px; border-radius: 8px; margin-top: 10px; }
    .radius-buttons button { margin-right: 10px; padding: 5px 10px; border-radius: 5px; background-color: #e0e7ff; border: none; cursor: pointer; }
    .radius-buttons button:hover { background-color: #c7d2fe; }
    input[type="text"] { padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
    button { padding: 6px 10px; border-radius: 4px; background-color: #38bdf8; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0ea5e9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: clamp(12px, 1.1vw, 16px); table-layout: fixed; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; word-break: break-word; }
    th { background-color: #eef2ff; }
    .info-card { padding: 15px; border: 1px solid #ddd; border-radius: 10px; background: #fff; margin-top: 10px; }
  </style>
</head>
<body>
  <img src="https://taksong-driver.openmile.kr/openlink.png" style="width: 139px; height: 22px;" />
  <h2>🏢 오픈링크 협력사 현황</h2>

  <div>
    <input type="text" id="addressInput" placeholder="🔍 주소 입력">
    <button onclick="searchAddress()">검색</button>
    <span>또는 🗺️ 지도 클릭으로 선택</span>
  </div>

  <div class="radius-buttons">
    <label>📏 반경:</label>
    <button onclick="setRadius(5)">5km</button>
    <button onclick="setRadius(10)">10km</button>
    <button onclick="setRadius(20)">20km</button>
  </div>

  <div id="map"></div>

  <div id="clicked-address">📍 표시지점의 주소가 표시됩니다.</div>
  <div id="clicked-location">📍 선택된 위치: 없음</div>
  <div id="factory-info">ℹ️ 협력사 정보가 여기에 표시됩니다.</div>

  <table>
    <thead>
      <tr>
        <th>공업사명</th>
        <th>거리(km)</th>
        <th>일반수리</th>
        <th>사고수리</th>
        <th>현대</th>
        <th>기아</th>
      </tr>
    </thead>
    <tbody id="factory-list"></tbody>
  </table>

  <script>
    let map, radius = 10, circle = null, selectedMarker = null;
    let factories = [], markers = [];

    function getStatusTag(flag) {
      if (flag === '○') return '✅';
      if (flag === 'Ⅹ' || flag === 'X') return '❌';
      return '-';
    }

    function showFactoryInfo(f) {
      document.getElementById("factory-info").innerHTML = `
        <div class="info-card">
          <strong>🚗 ${f.name}</strong><br>
          📍 ${f.address}<br>
          ☎️ ${f.phone || '-'}<br>
          🏷️ 등급: ${f.grade || '-'}<br>
          📦 월수리: ${f.monthlyCapacity || '-'}, 입고: ${f.currentIncoming || '-'}, 가능: ${f.possibleIncoming || '-'}<br>
          일반수리: ${getStatusTag(f.repairGeneral)}, 사고수리: ${getStatusTag(f.repairAccident)}<br>
          현대: ${getStatusTag(f.pointHyundai)}, 기아: ${getStatusTag(f.pointKia)}<br>
          📝 ${f.notes || ''}
        </div>`;
    }

    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371e3, toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function updateTableAndMarkers(center) {
      const tbody = document.getElementById("factory-list");
      tbody.innerHTML = '';

      markers.forEach(m => m.setMap(null));
      markers = [];

      factories.forEach(f => {
        const dist = haversine(center.lat(), center.lng(), f.lat, f.lng) / 1000;
        if (dist <= radius) {
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(f.lat, f.lng),
            map
          });
          marker.addListener("click", () => showFactoryInfo(f));
          markers.push(marker);

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${f.name}</td>
            <td>${dist.toFixed(2)}</td>
            <td>${getStatusTag(f.repairGeneral)}</td>
            <td>${getStatusTag(f.repairAccident)}</td>
            <td>${getStatusTag(f.pointHyundai)}</td>
            <td>${getStatusTag(f.pointKia)}</td>`;
          row.onclick = () => showFactoryInfo(f);
          tbody.appendChild(row);
        }
      });
    }

    function drawCircle(center) {
      if (circle) circle.setMap(null);
      circle = new naver.maps.Circle({
        map,
        center,
        radius: radius * 1000,
        strokeColor: "#007aff",
        strokeWeight: 2,
        fillColor: "#cce5ff",
        fillOpacity: 0.4
      });
    }

    function searchAddress() {
      const query = document.getElementById("addressInput").value;
      if (!query) return;
      naver.maps.Service.geocode({ query }, function(status, response) {
        if (status !== naver.maps.Service.Status.OK) return alert("주소 검색 실패");
        const item = response.v2.addresses[0];
        const latlng = new naver.maps.LatLng(item.y, item.x);
        if (selectedMarker) selectedMarker.setMap(null);
        selectedMarker = new naver.maps.Marker({ position: latlng, map });
        map.setCenter(latlng);
        document.getElementById("clicked-location").innerText = `📍 선택된 위치: ${item.roadAddress || item.jibunAddress}`;
        drawCircle(latlng);
        updateTableAndMarkers(latlng);
      });
    }

    function setRadius(r) {
      radius = r;
      if (selectedMarker) {
        drawCircle(selectedMarker.getPosition());
        updateTableAndMarkers(selectedMarker.getPosition());
      }
    }

    function initMap() {
      map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(36.5, 127.5),
        zoom: 8
      });

      fetch("https://jdanjeong.github.io/automechanic/factory.json")
        .then(res => res.json())
        .then(data => {
          factories = data;
        })
        .catch(err => alert("데이터 로딩 실패"));
    }

    window.onload = initMap;
  </script>
</body>
</html>
